<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLN Debate - Deep API Testing</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .test-section { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
        .success { border-color: #4CAF50; background-color: #f1f8e9; }
        .error { border-color: #f44336; background-color: #ffebee; }
        .info { border-color: #2196F3; background-color: #e3f2fd; }
        button { padding: 10px 20px; margin: 5px; background: #007AFF; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056CC; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .log { margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 4px solid #007AFF; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ MLN Debate - Deep API Testing</h1>
        
        <div class="test-section info">
            <h2>üìã Test Information</h2>
            <p><strong>API Base URL:</strong> https://mlndebate.io.vn/api</p>
            <p><strong>Endpoint:</strong> /debate/start</p>
            <p><strong>Method:</strong> POST</p>
        </div>

        <div class="test-section">
            <h2>üß™ Test Cases</h2>
            
            <h3>Test 1: New Team</h3>
            <button onclick="testNewTeam()">üÜï Test New Team</button>
            <div id="newTeamResult" class="log" style="display:none;"></div>
            
            <h3>Test 2: Existing Team</h3>
            <button onclick="testExistingTeam()">üîÑ Test Existing Team</button>
            <div id="existingTeamResult" class="log" style="display:none;"></div>
            
            <h3>Test 3: Validation Analysis</h3>
            <button onclick="testValidation()">üîç Analyze Validation Logic</button>
            <div id="validationResult" class="log" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>üìä Results Summary</h2>
            <div id="summary"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://mlndebate.io.vn/api';
        let testResults = [];

        async function makeRequest(url, data) {
            try {
                console.log('üî¨ Making request to:', url);
                console.log('üî¨ Request data:', data);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                console.log('üî¨ Raw response:', response);
                console.log('üî¨ Response status:', response.status);
                console.log('üî¨ Response ok:', response.ok);

                const responseData = await response.json();
                console.log('üî¨ Response data:', responseData);

                return {
                    status: response.status,
                    ok: response.ok,
                    data: responseData
                };
            } catch (error) {
                console.error('üî¨ Request error:', error);
                return {
                    error: error.message,
                    status: 0
                };
            }
        }

        async function testNewTeam() {
            const resultDiv = document.getElementById('newTeamResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '‚è≥ Testing new team...';

            const randomId = `DEEPTEST_${Date.now()}`;
            const testData = {
                members: ['User1', 'User2', 'User3', 'User4', 'User5'],
                course_code: 'MLN111',
                team_id: randomId
            };

            const result = await makeRequest(`${API_BASE}/debate/start`, testData);
            
            let html = `<h4>üÜï New Team Test</h4>`;
            html += `<p><strong>Team ID:</strong> ${randomId}</p>`;
            html += `<p><strong>HTTP Status:</strong> ${result.status}</p>`;
            
            if (result.error) {
                html += `<p style="color: red;"><strong>Error:</strong> ${result.error}</p>`;
                resultDiv.className = 'log error';
            } else {
                html += `<p><strong>Message:</strong> ${result.data.message}</p>`;
                html += `<p><strong>Response Data:</strong></p>`;
                html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                
                // Validation analysis
                const httpOk = result.status === 200;
                const message = result.data.message || '';
                const hasSuccessfully = message.includes('successfully');
                const hasAlreadyExists = message.includes('already exists');
                const hasSuccessMessage = hasSuccessfully || hasAlreadyExists;
                const isSuccess = httpOk && hasSuccessMessage;
                
                html += `<h5>üîç Validation Analysis:</h5>`;
                html += `<p>‚Ä¢ HTTP 200: ${httpOk}</p>`;
                html += `<p>‚Ä¢ Contains 'successfully': ${hasSuccessfully}</p>`;
                html += `<p>‚Ä¢ Contains 'already exists': ${hasAlreadyExists}</p>`;
                html += `<p>‚Ä¢ Has success message: ${hasSuccessMessage}</p>`;
                html += `<p>‚Ä¢ Final validation result: <strong>${isSuccess ? '‚úÖ SUCCESS' : '‚ùå FAILED'}</strong></p>`;
                
                resultDiv.className = isSuccess ? 'log success' : 'log error';
                testResults.push({
                    test: 'New Team',
                    success: isSuccess,
                    details: result
                });
            }
            
            resultDiv.innerHTML = html;
            updateSummary();
        }

        async function testExistingTeam() {
            const resultDiv = document.getElementById('existingTeamResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '‚è≥ Testing existing team...';

            // Use a team ID that likely exists
            const testData = {
                members: ['User1', 'User2', 'User3', 'User4', 'User5'],
                course_code: 'MLN111',
                team_id: 'DEEPTEST123' // This should exist from our earlier tests
            };

            const result = await makeRequest(`${API_BASE}/debate/start`, testData);
            
            let html = `<h4>üîÑ Existing Team Test</h4>`;
            html += `<p><strong>Team ID:</strong> DEEPTEST123</p>`;
            html += `<p><strong>HTTP Status:</strong> ${result.status}</p>`;
            
            if (result.error) {
                html += `<p style="color: red;"><strong>Error:</strong> ${result.error}</p>`;
                resultDiv.className = 'log error';
            } else {
                html += `<p><strong>Message:</strong> ${result.data.message}</p>`;
                html += `<p><strong>Response Data:</strong></p>`;
                html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                
                // Validation analysis
                const httpOk = result.status === 200;
                const message = result.data.message || '';
                const hasSuccessfully = message.includes('successfully');
                const hasAlreadyExists = message.includes('already exists');
                const hasSuccessMessage = hasSuccessfully || hasAlreadyExists;
                const isSuccess = httpOk && hasSuccessMessage;
                
                html += `<h5>üîç Validation Analysis:</h5>`;
                html += `<p>‚Ä¢ HTTP 200: ${httpOk}</p>`;
                html += `<p>‚Ä¢ Contains 'successfully': ${hasSuccessfully}</p>`;
                html += `<p>‚Ä¢ Contains 'already exists': ${hasAlreadyExists}</p>`;
                html += `<p>‚Ä¢ Has success message: ${hasSuccessMessage}</p>`;
                html += `<p>‚Ä¢ Final validation result: <strong>${isSuccess ? '‚úÖ SUCCESS' : '‚ùå FAILED'}</strong></p>`;
                
                resultDiv.className = isSuccess ? 'log success' : 'log error';
                testResults.push({
                    test: 'Existing Team',
                    success: isSuccess,
                    details: result
                });
            }
            
            resultDiv.innerHTML = html;
            updateSummary();
        }

        async function testValidation() {
            const resultDiv = document.getElementById('validationResult');
            resultDiv.style.display = 'block';
            
            let html = `<h4>üîç Frontend Validation Logic Analysis</h4>`;
            
            // Test the exact validation logic used in the frontend
            const testCases = [
                { message: 'Debate started successfully', expected: true },
                { message: 'Team already exists, returning existing session', expected: true },
                { message: 'Error occurred', expected: false },
                { message: '', expected: false },
                { message: null, expected: false },
                { message: undefined, expected: false }
            ];
            
            html += `<h5>üß™ Test Cases:</h5>`;
            
            testCases.forEach((testCase, index) => {
                const message = testCase.message || '';
                const includesSuccessfully = message.includes('successfully');
                const includesAlreadyExists = message.includes('already exists');
                const hasSuccessMessage = includesSuccessfully || includesAlreadyExists;
                const result = hasSuccessMessage;
                
                const status = result === testCase.expected ? '‚úÖ PASS' : '‚ùå FAIL';
                html += `<p><strong>Test ${index + 1}:</strong> "${testCase.message}" ‚Üí ${status}</p>`;
                html += `<p>  ‚Ä¢ Includes 'successfully': ${includesSuccessfully}</p>`;
                html += `<p>  ‚Ä¢ Includes 'already exists': ${includesAlreadyExists}</p>`;
                html += `<p>  ‚Ä¢ Result: ${result}, Expected: ${testCase.expected}</p>`;
                html += `<hr style="margin: 10px 0;">`;
            });
            
            resultDiv.innerHTML = html;
            resultDiv.className = 'log info';
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            if (testResults.length === 0) {
                summaryDiv.innerHTML = '<p>No tests completed yet.</p>';
                return;
            }
            
            const successCount = testResults.filter(t => t.success).length;
            const totalCount = testResults.length;
            
            let html = `<h3>üìà Test Summary</h3>`;
            html += `<p><strong>Tests Completed:</strong> ${totalCount}</p>`;
            html += `<p><strong>Successful:</strong> ${successCount}</p>`;
            html += `<p><strong>Failed:</strong> ${totalCount - successCount}</p>`;
            html += `<p><strong>Success Rate:</strong> ${((successCount / totalCount) * 100).toFixed(1)}%</p>`;
            
            if (successCount === totalCount) {
                html += `<p style="color: green; font-weight: bold;">üéâ All API tests passed! The backend is working correctly.</p>`;
                html += `<p style="color: orange; font-weight: bold;">‚ö†Ô∏è If the frontend is still failing, the issue is with browser caching or frontend validation logic.</p>`;
            }
            
            summaryDiv.innerHTML = html;
        }
    </script>
</body>
</html> 